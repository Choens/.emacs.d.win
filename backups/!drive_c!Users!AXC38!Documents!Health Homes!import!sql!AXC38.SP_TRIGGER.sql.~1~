create view hhweb.v_new_segment as
select
    hhcurr.cal_month
    ,hhcurr.recip_id
    ,hhcurr.health_home_mmis_id
    ,hhcurr.plan_id
    ,hhcurr.care_mgmt_agency_mmis_id
    ,hhcurr.direct_bill_ind
    ,hhcurr.outreach_enroll_code
    ,hhcurr.referral_code
    ,hhcurr.begin_month_ind
    ,hhcurr.end_month_ind
    ,hhcurr.disenroll_code
    ,max(hhprev.cal_month) pre_cal_month
    ,count(hhprev.cal_month) previous_segments_n
    ,case when hhcurr.cal_month -  max(hhprev.cal_month) > 61 then 1
          when hhcurr.cal_month -  max(hhprev.cal_month) <= 61 then 5
          when max(hhprev.cal_month) is null then 0
     else null end new_segment
    ,case when hhcurr.cal_month -  max(hhprev.cal_month) > 61 then 'Yes'
          when hhcurr.cal_month -  max(hhprev.cal_month) <= 61 then 'No'
          when max(hhprev.cal_month) is null then 'Initial Segment'
     else null end new_segment_desc
from hhweb.hh_recip_profile hhcurr
     left join hhweb.hh_recip_profile hhprev
     on hhcurr.recip_id = hhprev.recip_id
        and hhprev.cal_month < hhcurr.cal_month
        and hhcurr.begin_month_ind = 'Y' and hhprev.END_MONTH_IND = 'Y'
group by
    hhcurr.cal_month
    ,hhcurr.recip_id
    ,hhcurr.health_home_mmis_id
    ,hhcurr.plan_id
    ,hhcurr.care_mgmt_agency_mmis_id
    ,hhcurr.direct_bill_ind
    ,hhcurr.outreach_enroll_code
    ,hhcurr.referral_code
    ,hhcurr.begin_month_ind
    ,hhcurr.end_month_ind
    ,hhcurr.disenroll_code
;

-- I assume I will be able to get that built some day . . . but in the mean time . . . .

select
    thc.cin
    ,thc.report_date
    ,thc.report_period
    ,thc.hh_id
    ,thc.plan_id
    ,max(vns.cal_month) "TRIGGER?"
from
    (
     -- THC --------------------------------------------------------------------
     select *
     from axc38.t_hh_cmart
     where cin in (
                   'AA02352D'
                   ,'AA02514Z'
                   ,'AA03414R'
                   ,'AA06193G'
                   ,'AA07181Y'
                   ,'AA01131Z'
                   ,'AA01409U'
                   ,'AA02956T'
                   ,'AA03174R'
                   ,'AA03399D'
                   ,'AA00270T'
                   ,'AA00310K'
                   ,'AA00356E'
                   ,'AA00453C'
                   ,'AA00481U'
                   ,'AA00627Q'
                   ,'AA01627X'
                   ,'AA01938Q'
                   ,'AA08500H'
                   ,'AA09423J'
                   ,'AA01517K'
                   ,'AA02984J'
                   ,'AA03235X'
                   ,'AA03885Y'
                   ,'AA07471B'
                   ,'AA01298Z'
                   ,'AA04783U'
                   ,'AA05788R'
                   ,'AA06960G'
                   ,'AA07199B'
                   ,'AA02354Z'
                   ,'AA04052V'
                   ,'AA06943J'
                   ,'AA07397P'
                   ,'AA14866C'
                   ,'AA04515N'
                   ,'AA05298E'
                   ,'AA11210S'
                   ,'AA17269W'
                   ,'AA17928E'
                   ,'AA01040F'
                   ,'AA01885H'
                   ,'AA02561J'
                   ,'AA02976J'
                   ,'AA03545S'
                   ,'AA03576B'
                   ,'AA05904S'
                   ,'AA09871G'
                   ,'AA15405Y'
                   ,'AA20315E'
                   ,'AA01391F'
                   ,'AA03338G'
                   ,'AA06179C'
                   ,'AA16497N'
                   ,'AA18080G'
                   ,'AA02634G'
                   ,'AA04013K'
                   ,'AA07427K'
                   ,'AA07944Q'
                   ,'AA07957D'
                   ,'AA00933T'
                   ,'AA07169Q'
                   ,'AA42208G'
                   ,'AA46784T'
                   ,'AA62191X'
                   ,'AA24590U'
                   ,'AA31562V'
                   ,'AA45286Z'
                   ,'AA45489A'
                   ,'AA51840N'
                   ,'AA06483K'
                   ,'AA18903G'
                   ,'AA81298W'
                   ,'AA85865U'
                   ,'AA98389H'
                   ,'AA16689V'
                   ,'AA49417R'
                   ,'AA53369T'
                   ,'AA81464A'
                   ,'AA86881B'
                   ,'AA02014T'
                   ,'AA03066Z'
                   ,'AA05084K'
                   ,'AA15161G'
                   ,'AA68967Y'
                   ,'AA26188F'
                   ,'AB07245D'
                   ,'AB72331B'
                   ,'AB95336U'
                   ,'AC19662C'
                   ,'AA14712S'
                   ,'AA35933B'
                   ,'AA56952H'
                   ,'AA61057C'
                   ,'AA77435S'
                   ,'AA02144W'
                   ,'AA58995Z'
                   ,'AA78814A'
                   ,'AA80737Y'
                   ,'AB04048S'
                   ,'AA13763K'
                   ,'AA14432J'
                   ,'AA15160J'
                   ,'AA15416S'
                   ,'AA21888G'
                   ,'AA03294Y'
                   ,'AA56907U'
                   ,'AA86153W'
                   ,'AB06291H'
                   ,'AB07815Q'
                   ,'AA09176G'
                   ,'AA60431G'
                   ,'AA79129D'
                   ,'AB28961F'
                   ,'AB32896K'
                   ,'AA04174Y'
                   ,'AA25250V'
                   ,'AA44563F'
                   ,'AA45033V'
                   ,'AA49608A'
                   ,'AA43511Z'
                   ,'AA50625V'
                   ,'AA97299E'
                   ,'AC06064N'
                   ,'AC16869X'
                   ,'AB13241X'
                   ,'AE59595P'
                   ,'AE92513K'
                   ,'AF94057Y'
                   ,'AF97842S'
                   ,'AA39392K'
                   ,'AA39862E'
                   ,'AA40003V'
                   ,'AA40076H'
                   ,'AA42830J'
                  )
     -- THC --------------------------------------------------------------------
    ) thc
    inner join axc38.l_reports lr
    on thc.report_period = lr.report_period
    left join
    (
     -- VNS --------------------------------------------------------------------
     select
         hhcurr.cal_month
         ,hhcurr.recip_id
         ,hhcurr.health_home_mmis_id
         ,hhcurr.plan_id
         ,hhcurr.care_mgmt_agency_mmis_id
         ,hhcurr.direct_bill_ind
         ,hhcurr.outreach_enroll_code
         ,hhcurr.referral_code
         ,hhcurr.begin_month_ind
         ,hhcurr.end_month_ind
         ,hhcurr.disenroll_code
         ,max(hhprev.cal_month) pre_cal_month
         ,count(hhprev.cal_month) previous_segments_n
         ,case when hhcurr.cal_month -  max(hhprev.cal_month) > 61 then 1
               when hhcurr.cal_month -  max(hhprev.cal_month) <= 61 then 5
               when max(hhprev.cal_month) is null then 0
          else null end new_segment
         ,case when hhcurr.cal_month -  max(hhprev.cal_month) > 61 then 'Yes'
               when hhcurr.cal_month -  max(hhprev.cal_month) <= 61 then 'No'
               when max(hhprev.cal_month) is null then 'Initial Segment'
          else null end new_segment_desc
     from hhweb.hh_recip_profile hhcurr
          left join hhweb.hh_recip_profile hhprev
          on hhcurr.recip_id = hhprev.recip_id
             and hhcurr.health_home_mmis_id = hhprev.health_home_mmis_id
             and hhprev.cal_month < hhcurr.cal_month
             and hhprev.end_month_ind = 'Y'
     where hhcurr.begin_month_ind = 'Y'
     group by
         hhcurr.cal_month
         ,hhcurr.recip_id
         ,hhcurr.health_home_mmis_id
         ,hhcurr.plan_id
         ,hhcurr.care_mgmt_agency_mmis_id
         ,hhcurr.direct_bill_ind
         ,hhcurr.outreach_enroll_code
         ,hhcurr.referral_code
         ,hhcurr.begin_month_ind
         ,hhcurr.end_month_ind
         ,hhcurr.disenroll_code
     -- VNS --------------------------------------------------------------------
    ) vns
    on thc.cin = vns.recip_id
       and vns.cal_month  <= lr.end_date
       and vns.new_segment < 5 -- this is my encoding for a new segment.
group by
    thc.cin
    ,thc.report_date
    ,thc.report_period
    ,thc.hh_id
    ,thc.plan_id
order by
    thc.cin
    ,thc.report_date
    ,thc.report_period
    ,thc.hh_id
    ,thc.plan_id
;
