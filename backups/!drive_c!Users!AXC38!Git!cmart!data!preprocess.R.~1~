# ##############################################################################
# PreProcess Data
#
# PreProcesses the annual CMART files.
# Prepares the data to be uploaded to the Oracle database.
#
# ##############################################################################

# ==============================================================================
# Functions
# ==============================================================================
SimpleCap <- function(x) {
    s <- strsplit(x, " ")[[1]]
    paste(toupper(substring(s, 1,1))
          ,substring(s, 2)
          ,sep=""
          ,collapse=" "
         )
}


# ==============================================================================
# Pre Processing
# ==============================================================================

# ------------------------------------------------------------------------------
# Lower Case Column Names
#
# I hate tricky column names.
#
# ------------------------------------------------------------------------------

names(combined_mem) = tolower( names(combined_mem) )

str(combined_mem)
'data.frame':	128554 obs. of  31 variables:
 $ clientid      : int  1050178 1050178 1050178 1050178 1050178 1050178 1050178 1050178 1050178 1050178 ...
 $ cin           : chr  "RE73903J" "BT65426M" "XN83930W" "VR22834S" ...
 $ lastname      : chr  "NYARKO" "REYNOLDS" "AVANT" "ALMONTE  FLORES" ...
 $ firstname     : chr  "MILDRED" "THEODORE" "WAYNE" "DANIELA" ...
 $ dob           : chr  "12/11/1999" "07/17/1963" "03/30/1960" "01/16/1994" ...
 $ triggerdate   : chr  "12/17/2012" "12/13/2012" "11/30/2012" "12/19/2012" ...
 $ programtype   : chr  "Behavioral Health" "Behavioral Health" "Chronic Adult" "High Risk OB" ...
 $ ablecontact   : chr  "Yes" "No" "No" "Yes" ...
 $ contactdate   : chr  "12/17/2012" "" "" "12/27/2012" ...
 $ appropriatecm : chr  "Yes" "Not Able to Contact" "Not Able to Contact" "Yes" ...
 $ refusedcm     : chr  "Did not refuse" "Not offered CM" "Not offered CM" "Refused" ...
 $ enrolledcm    : chr  "Yes" "No" "No" "No" ...
 $ enrollcmdate  : chr  "12/17/2012" "" "" "" ...
 $ intensity     : chr  "High" "" "" "" ...
 $ countmail     : int  1 NA NA NA NA NA NA NA 0 4 ...
 $ countphone    : int  6 NA NA NA NA NA NA NA 7 10 ...
 $ countperson   : int  0 NA NA NA NA NA NA NA 0 1 ...
 $ caseclosed    : chr  "Closed" "" "" "" ...
 $ closuredate   : chr  "01/29/2013" "" "" "" ...
 $ reasonclosure : chr  "Met program goals" "" "" "" ...
 $ casereopened  : chr  "Not reopened" "" "" "" ...
 $ datereopened  : chr  "" "" "" "" ...
 $ programtype2  : int  1 1 4 2 2 4 4 4 1 2 ...
 $ ablecontact2  : int  1 0 0 1 1 0 1 0 1 1 ...
 $ appropriatecm2: int  1 2 2 1 1 2 1 2 1 1 ...
 $ refusedcm2    : int  0 2 2 1 1 2 1 2 0 0 ...
 $ enrolledcm2   : int  1 0 0 0 0 0 0 0 1 1 ...
 $ intensity2    : int  3 NA NA NA NA NA NA NA 3 3 ...
 $ caseclosed2   : int  0 NA NA NA NA NA NA NA 1 0 ...
 $ reasonclosure2: int  1 NA NA NA NA NA NA NA 6 1 ...
 $ casereopened2 : int  0 NA NA NA NA NA NA NA 2 0 ...

# ------------------------------------------------------------------------------
# Standardize Capitalization
# SKIPPED
# ------------------------------------------------------------------------------

combined_mem$programtype   = SimpleCap(combined_mem$programtype)
combined_mem$ablecontact   = SimpleCap(combined_mem$ablecontact)
combined_mem$appropriatecm = SimpleCap(combined_mem$appropriatecm)
combined_mem$refusedcm     = SimpleCap(combined_mem$refusedcm)
combined_mem$enrolledcm    = SimpleCap(combined_mem$enrolledcm)
combined_mem$intensity     = SimpleCap(combined_mem$intensity)
combined_mem$caseclosed    = SimpleCap(combined_mem$caseclosed)
combined_mem$reasonclosure = SimpleCap(combined_mem$reasonclosure)

# ------------------------------------------------------------------------------
# Plan Name
# TODO - Include PLANNAME in the DDL for the table.
# ------------------------------------------------------------------------------
combined_mem$planname[combined_mem$clientid == 1070680] = 'Independent Health'
combined_mem$planname[combined_mem$clientid == 2010186] = 'Affinity'
combined_mem$planname[combined_mem$clientid == 2180196] = 'Health Plus_Amerigroup'
combined_mem$planname[combined_mem$clientid == 1090384] = 'CDPHP'
combined_mem$planname[combined_mem$clientid == 1390598] = 'Excellus'
combined_mem$planname[combined_mem$clientid == 2060193] = 'Fidelis'
combined_mem$planname[combined_mem$clientid == 1050178] = 'HIP'
combined_mem$planname[combined_mem$clientid == 2090194] = 'Health First'
combined_mem$planname[combined_mem$clientid == 1140685] = 'HealthNow'
combined_mem$planname[combined_mem$clientid == 2040287] = 'Hudson'
combined_mem$planname[combined_mem$clientid == 1080383] = 'MVP'
combined_mem$planname[combined_mem$clientid == 1130185] = 'MetroPlus'
combined_mem$planname[combined_mem$clientid == 2150195] = 'Neighborhood'
combined_mem$planname[combined_mem$clientid == 2020487] = 'Total Care'
combined_mem$planname[combined_mem$clientid == 2190696] = 'Univera'
combined_mem$planname[combined_mem$clientid == 1260187] = 'UnitedHealthCare'
combined_mem$planname[combined_mem$clientid == 1240287] = 'WellCare'

# ------------------------------------------------------------------------------
# Age
# TODO - Include AGE in the DDL for the table.
# Let's do this dplyr style. Wheeeeeeee
# ------------------------------------------------------------------------------

combined_mem = mutate( combined_mem
	,age = ifelse(is.na( triggerdate) == TRUE
         ,ifelse(is.na( contactdate) == TRUE
				 ,(as.Date(contactdate, format = "%m/%d/%Y") - as.Date(dob, format = "%m/%d/%Y")) / 365.25
				 ,(as.Date(enrollcmdate, format = "%m/%d/%Y") - as.Date(dob, format = "%m/%d/%Y")) / 365.25
				 )
         ,(as.Date(triggerdate, format = "%m/%d/%Y") - as.Date(dob, format = "%m/%d/%Y")) / 365.25
         )
    )

# ------------------------------------------------------------------------------
# Total Interventions
# TODO - Include Total Intervetions in the DDL for the table.
# ------------------------------------------------------------------------------

combined_mem = mutate( combined_mem
    ,totinterven = ifelse(countmail == 999 | countphone == 999 | countperson == 999
         ,999
         ,countmail + countphone + countperson
         )
    )

