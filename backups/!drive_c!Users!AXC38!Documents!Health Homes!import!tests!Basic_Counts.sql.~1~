-- =============================================================================
-- BASIC COUNTS!
-- =============================================================================

-- With Everything!
select report_date, count(*)
from axc38.t_hh_cmart
group by report_date
order by report_date
;

select report_date, count(distinct cin)
from axc38.t_hh_cmart
group by report_date
order by report_date
;

select report_date, count(*)
from ( select distinct cin, hh_id, report_date from axc38.t_hh_cmart ) src0
group by report_date
order by report_date
;

-- Removing Invalid CINS
select report_date, count(*)
from axc38.t_hh_cmart
where
    upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
    and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
    and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
    and length(CIN) = 8
group by report_date
order by report_date
;

select report_date, count(distinct cin)
from axc38.t_hh_cmart
where
    upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
    and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
    and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
    and length(CIN) = 8
group by report_date
order by report_date
;

select report_date, count(*)
from (
       select distinct cin, hh_id, report_date
       from axc38.t_hh_cmart
       where
           upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
           and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
           and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
           and length(CIN) = 8
     ) src0
group by report_date
order by report_date
;


-- =============================================================================
-- Discounting The Invalid CINS, How Many Connections Can We Make to HHWEB?
-- =============================================================================

select
    report_date
    ,sum( case when recip_id is null then 1 else 0 end ) missing
    ,count(*) total
from (
       select
           report_date
           ,thc.cin
           ,thc.hh_id
           ,hrp.recip_id
       from (
             select distinct cin, hh_id, report_date
             from axc38.t_hh_cmart
             where
                 upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
                 and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
                 and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
                 and length(CIN) = 8
            ) thc
            left join
            (
             select distinct recip_id, cast(health_home_mmis_id as int) health_home_mmis_id
             from hhweb.hh_recip_profile
             where cal_month between to_date('2013-01-01', 'yyyy-mm-dd') and to_date('2013-12-31','yyyy-mm-dd')
            ) hrp
            on thc.cin = hrp.recip_id
               and thc.hh_id =  hrp.health_home_mmis_id
     ) src0
group by report_date
order by report_date
;

-- =============================================================================
-- Discounting The Invalid CINS, How Many Connections Can We Make to HHWEB?
-- =============================================================================
select
    report_date
    ,hh_id
    ,hhh.health_home_program_name
    ,sum( case when recip_id is null then 1 else 0 end ) missing
    ,count(*) total
from (
       select
           report_date
           ,thc.cin
           ,thc.hh_id
           ,hrp.recip_id
       from (
             select distinct cin, hh_id, report_date
             from axc38.t_hh_cmart
             where
                 upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
                 and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
                 and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
                 and length(CIN) = 8
            ) thc
            left join
            (
             select distinct recip_id, cast(health_home_mmis_id as int) health_home_mmis_id
             from hhweb.hh_recip_profile
             where cal_month between to_date('2013-01-01', 'yyyy-mm-dd') and to_date('2013-12-31','yyyy-mm-dd')
            ) hrp
            on thc.cin = hrp.recip_id
               and thc.hh_id =  hrp.health_home_mmis_id
     ) src0
    left join hhweb.hh_health_homes hhh
    on src0.hh_id = cast( hhh.health_home_mmis_id  as int)
group by
    report_date
    ,hh_id
    ,hhh.health_home_program_name
order by 
    sum( case when recip_id is null then 1 else 0 end ) DESC
    ,hh_id
    ,hhh.health_home_program_name
;


-- =============================================================================
-- Discounting The Invalid CINS, How Many Connections Can We Make to the
-- NETTED LINES schema?
-- =============================================================================
select
    report_date
    ,hh_id
    ,hhh.health_home_program_name
    ,sum( case when recip_id is null then 1 else 0 end ) missing
    ,count(*) total
from (
       select
           report_date
           ,thc.cin
           ,thc.hh_id
           ,hrp.recip_id
       from (
             select distinct cin, hh_id, report_date
             from axc38.t_hh_cmart
             where
                 upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
                 and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
                 and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
                 and length(CIN) = 8
            ) thc
            left join
            (
             select distinct recip_id
             from net.recip_profile
             where elig_month_1st_day between to_date('2013-01-01', 'yyyy-mm-dd') and to_date('2013-12-31','yyyy-mm-dd')
            ) hrp
            on thc.cin = hrp.recip_id
     ) src0
    left join hhweb.hh_health_homes hhh
    on src0.hh_id = cast( hhh.health_home_mmis_id  as int)
group by
    report_date
    ,hh_id
    ,hhh.health_home_program_name
order by 
    sum( case when recip_id is null then 1 else 0 end ) DESC
    ,hh_id
    ,hhh.health_home_program_name
;


-- ###############################################################

-- =============================================================================
-- How Many Are in HHWEB but NOT CMART?
-- =============================================================================
select
    report_period
    ,src0.health_home_mmis_id
    ,health_home_program_name
    ,sum( case when hh_id is null then 1 else 0 end ) missing
    ,count(*) total
from (
       select
           hrp.recip_id
           ,report_period
           ,hrp.health_home_mmis_id
           ,thc.hh_id
       from (
             select distinct cin, hh_id
             from axc38.t_hh_cmart
             where
                 upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
                 and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
                 and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
                 and length(CIN) = 8
            ) thc
            right join
            (
             select distinct 
                 recip_id
                 ,case when cal_month between to_date('2013-01-01', 'yyyy-mm-dd') and to_date('2013-06-30','yyyy-mm-dd')
                       then '2/2014'
                       when cal_month between to_date('2013-07-01', 'yyyy-mm-dd') and to_date('2013-09-30','yyyy-mm-dd')
                       then '3/2014'
                       when cal_month between to_date('2013-10-01', 'yyyy-mm-dd') and to_date('2013-12-31','yyyy-mm-dd')
                       then '4/2014'
                       else 'Error'
                  end report_period
                 ,cast(health_home_mmis_id as int) health_home_mmis_id
             from hhweb.hh_recip_profile
             where cal_month between to_date('2013-01-01', 'yyyy-mm-dd') and to_date('2013-12-31','yyyy-mm-dd')
            ) hrp
            on thc.cin = hrp.recip_id
               and thc.hh_id =  hrp.health_home_mmis_id
     ) src0
    left join hhweb.hh_health_homes hhh
    on src0.health_home_mmis_id =  hhh.health_home_mmis_id
group by
    report_period
    ,src0.health_home_mmis_id
    ,health_home_program_name
order by 
    sum( case when hh_id is null then 1 else 0 end ) DESC
    ,src0.health_home_mmis_id
    ,report_period
;


        
-- =============================================================================
-- Too Many Combos
-- =============================================================================
select
    thc.*
from (
       select cin, hh_id, report_date, count(*)
       from axc38.t_hh_cmart
       where
           upper(substr(CIN,3,5)) like lower(substr(CIN,3,5))
           and upper(substr(CIN,1,2)) != lower(substr(CIN,1,2))
           and upper(substr(CIN,8,8)) != lower(substr(CIN,8,8))
           and length(CIN) = 8
       group by cin, hh_id, report_date
       having count(*) > 1
     ) src0
     inner join axc38.t_hh_cmart thc
     on src0.cin = thc.cin
        and src0.hh_id = thc.hh_id
        and src0.report_date = thc.report_date
order by thc.cin, thc.hh_id, thc.report_date
;
