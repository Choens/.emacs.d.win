-- #############################################################################
-- SP_CREATE_HH_RECIP_PROFILE
--
-- Creates the table T_HH_POPULATION table.
--
-- T_HH_RECIP_PROFILE is structured like the HHWEB.HH_RECIP_PROFILE.
-- Each recipient can have, at most, one row per month.
-- Where the column names duplicate across the two tables, they have the same
-- meaning.
-- T_HH_RECIP_PROFILE has an aditional set of columns at the very end which 
-- identify which data sources an individual can be found in.
--
-- This is a three step process.
-- 1 Creates the initial table based on individuals who are in HHWEB. This step
--   identifies individuals who are also in HH_CMART.
-- 2 Adds all individuals who are in CMART but not HHWEB
-- 3 Adds all individuals identified via rate codes but are not in either HHWEB
--   or CMART.
--
-- #############################################################################


create or replace procedure SP_CREATE_POPULATION
is
begin

    -- DROP T_HH_RECIP_PROFILE -------------------------------------------------
    -- TODO - Improve error handling here.
    drop table axc38.t_hh_recip_profile ;

    -- Step 1 - Individuals in HHWEB, CMART ------------------------------------
    create table t_hh_recip_profile as
    select
        hrp.*
        ,1 hhweb
        ,(case when thc.CIN is null then 0 else 1 end) cmart
        ,0 rate_codes
    from HHWEB.HH_RECIP_PROFILE hrp
        left join (select distinct cin from AXC38.T_HH_CMART) thc
        on thc.cin = hrp.recip_id
        -- where cal_month = '01-DEC-13' /* looking at a sliver of query*/
    ;
-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

    /*Everyone in CMART but not in HHWEB*/
    create table tmp_Missing as
    select distinct
        thc.cin
        ,thc.hh_id
        ,thc.report_period
        ,lr.begin_date
        ,lr.end_date
        ,thc.engaged_cm
    from
        (select distinct cin,hh_id, report_period, engaged_cm from AXC38.T_HH_CMART) thc
        inner join axc38.l_reports lr
        on thc.report_period = lr.report_period
        left join (select distinct recip_id ,cal_month from hhweb.hh_recip_profile) hhrp
        on hhrp.recip_id = thc.cin
           and hhrp.cal_month between lr.begin_date and lr.end_date
           and hhrp.cal_month >=  '01Jan12'
    where hhrp.recip_id is null 
    ;
    commit;
     
    create unique index tmp_missing_pk on tmp_missing (cin, hh_id, report_period);
    commit;
     
    select distinct
         rp.ELIG_MONTH_1ST_DAY as cal_month
        ,rp.RECIP_ID
        ,tm.hh_id as health_home_mmis_id
        ,rp.PLAN_ID
        ,null as care_mgmt_agency
        ,null as direct_bill
        ,(case when tm.engaged_cm = 'No' then 'O'
              when tm.engaged_cm= 'Yes' then 'E'
              else 'nothing' /*change name */ end ) outreach_enroll_code
        ,null as referral_code
        ,null as begin_month_ind
        ,null as end_month_ind
        ,null as disenroll_code
        ,5 "CMART"
    from
        tmp_missing tm
        inner join net.RECIP_PROFILE rp
        on tm.cin = rp.recip_id
           and rp.elig_month_1st_day between tm.begin_date and tm.end_date
           and rp.elig_month_1st_day >= '01Jan12'
    order by recip_id , cal_month
    ;
     
    drop table axc38.tmp_MISSING ;

    /**Everyone who is in CMART and NOT in HHWEB (CMART - Tracking)**/
    --insert /*+ append */ into CXH21.T_YOUR_TABLE_NAME --TO DO STILL--
    
/**Everyone who is not in either CMART or HHWEB, but in a Health Home**/


-- !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!    
end -- SP_CREATE_POPULATION
;

